version: '3.8'

services:
  # --- API GATEWAY ---
  gateway:
    image: nginx:1.25-alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "8080:8080" # Main API port
    depends_on:
      - auth-service
      - client-service
      - tenant-service

  # --- FRONTENDS ---
  frontend:
    build:
      context: .
      dockerfile: ./apps/frontend/Dockerfile
    ports:
      - "5173:5173"
    volumes:
      - ./apps/frontend:/app/apps/frontend
      - ./packages/ui:/app/packages/ui
      - frontend_root_node_modules:/app/node_modules
      - frontend_app_node_modules:/app/apps/frontend/node_modules
      - frontend_pnpm_store:/app/.pnpm-store
      - frontend_react_router:/app/apps/frontend/.react-router

  user-docs:
    build:
      context: .
      dockerfile: ./apps/user-docs/Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./apps/user-docs:/app/apps/user-docs
      - ./packages/ui:/app/packages/ui
      - user_docs_root_node_modules:/app/node_modules
      - user_docs_app_node_modules:/app/apps/user-docs/node_modules
      - user_docs_pnpm_store:/app/.pnpm-store
      - user_docs_react_router:/app/apps/user-docs/.react-router

  # --- BACKEND SERVICES ---
  auth-service:
    build:
      context: .
      dockerfile: ./services/auth-service/Dockerfile
      target: development
    working_dir: /app/services/auth-service
    volumes:
      - ./go.work:/app/go.work
      - ./packages:/app/packages
      - ./services/auth-service:/app/services/auth-service
    environment:
      AUDITY_AUTH_DATABASE_TENANT_DB_URL: "postgres://root:password@postgres:5432/tenant_db?sslmode=disable"
    depends_on:
      - postgres
    # No ports exposed to host. Only gateway talks to it.

  tenant-service:
    build:
      context: .
      dockerfile: ./services/tenant-service/Dockerfile
      target: development
    working_dir: /app/services/tenant-service
    volumes:
      - ./go.work:/app/go.work
      - ./packages:/app/packages
      - ./services/tenant-service:/app/services/tenant-service
    environment:
      TENANT_DB_URL: "postgres://root:password@postgres:5432/tenant_db?sslmode=disable"
    depends_on:
      - postgres
      - rabbitmq
    # No ports exposed to host. Only gateway talks to it.

  client-service:
    build:
      context: .
      dockerfile: ./services/client-service/Dockerfile
      target: development
    working_dir: /app/services/client-service
    volumes:
      - ./go.work:/app/go.work
      - ./go.work.sum:/app/go.work.sum
      - ./packages:/app/packages
      - ./services/auth-service:/app/services/auth-service
      - ./services/tenant-service:/app/services/tenant-service
      - ./services/client-service:/app/services/client-service
    environment:
      CLIENT_DB_URL: "postgres://root:password@postgres:5432/tenant_db?sslmode=disable"
    depends_on:
      - postgres
      - minio
    # No ports exposed to host. Only gateway talks to it.

  # --- INFRASTRUCTURE ---
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: password
      POSTGRES_DB: tenant_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  minio:
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadminpassword
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000" # API
      - "9001:9001" # Console
    volumes:
      - minio_data:/data

  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI

volumes:
  postgres_data:
  minio_data:
  # Frontend node_modules volumes (isolated from local)
  frontend_root_node_modules:
  frontend_app_node_modules:
  frontend_pnpm_store:
  frontend_react_router:
  # User-docs node_modules volumes (isolated from local)
  user_docs_root_node_modules:
  user_docs_app_node_modules:
  user_docs_pnpm_store:
  user_docs_react_router: